import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.7.1'

// Initialize Supabase client
const supabaseUrl = Deno.env.get('SUPABASE_URL')!;
const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!;
const supabase = createClient(supabaseUrl, supabaseServiceKey);

// Get API keys
const ANTHROPIC_API_KEY = Deno.env.get('ANTHROPIC_API_KEY');
const TAVILY_API_KEY = Deno.env.get('TAVILY_API_KEY');
const RUNWARE_API_KEY = Deno.env.get('RUNWARE_API_KEY');

console.log("üöÄ WAKTI AI V2: MEGA-MERGED UNIFIED SYSTEM - VISION + CONVERSATION");

// MEMORY-EFFICIENT BASE64 CONVERSION - HANDLES LARGE IMAGES
function uint8ArrayToBase64(uint8Array: Uint8Array): string {
  const chunkSize = 8192; // Process in 8KB chunks to avoid memory overflow
  let binaryString = '';
  
  for (let i = 0; i < uint8Array.length; i += chunkSize) {
    const chunk = uint8Array.slice(i, i + chunkSize);
    binaryString += String.fromCharCode.apply(null, Array.from(chunk));
  }
  
  return btoa(binaryString);
}

// ENHANCED: CDN-aware image processing with timing-based retry mechanism
async function convertImageUrlToBase64(imageUrl: string, retryCount = 0): Promise<string | null> {
  const maxRetries = 4; // Total of 5 attempts (0-4)
  const baseDelay = 2000; // Start with 2 seconds
  
  try {
    console.log(`üîç CDN-AWARE PROCESSING - Attempt ${retryCount + 1}/${maxRetries + 1}:`);
    console.log(`üìã URL: ${imageUrl}`);
    console.log(`‚è±Ô∏è Retry count: ${retryCount}`);
    
    // ENHANCED: Pre-fetch delay for fresh uploads (first attempt only)
    if (retryCount === 0) {
      console.log('‚è≥ INITIAL DELAY: Waiting 3 seconds for CDN propagation...');
      await new Promise(resolve => setTimeout(resolve, 3000));
    }
    
    if (!imageUrl.startsWith('http')) {
      console.error('‚ùå INVALID URL: Does not start with http/https');
      return null;
    }
    
    // Enhanced URL validation
    const urlPattern = /^https:\/\/[a-zA-Z0-9.-]+\.supabase\.co\/storage\/v1\/object\/public\/[a-zA-Z0-9_-]+\//;
    if (!urlPattern.test(imageUrl)) {
      console.error('‚ùå INVALID URL PATTERN: Not a valid Supabase storage URL');
      return null;
    }
    
    // ENHANCED: CDN cache busting with timestamp
    const cacheBustUrl = `${imageUrl}${imageUrl.includes('?') ? '&' : '?'}cb=${Date.now()}&retry=${retryCount}`;
    console.log('üîÑ Using cache-busted URL for CDN freshness');
    
    // Extended timeout for CDN operations
    const timeout = 45000; // 45 seconds
    const controller = new AbortController();
    const timeoutId = setTimeout(() => {
      console.error('‚è∞ TIMEOUT: Request exceeded 45 seconds');
      controller.abort();
    }, timeout);
    
    console.log('üåê Starting CDN-aware HTTP request...');
    const startTime = Date.now();
    
    const response = await fetch(cacheBustUrl, {
      signal: controller.signal,
      headers: {
        'User-Agent': 'WAKTI-AI-CDN-AWARE/2.0',
        'Accept': 'image/*',
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
    
    const fetchDuration = Date.now() - startTime;
    clearTimeout(timeoutId);
    
    console.log(`üìä CDN Response Analysis:`, {
      status: response.status,
      statusText: response.statusText,
      ok: response.ok,
      contentType: response.headers.get('Content-Type'),
      contentLength: response.headers.get('Content-Length'),
      fetchTime: `${fetchDuration}ms`,
      cacheControl: response.headers.get('Cache-Control'),
      etag: response.headers.get('ETag'),
      attempt: retryCount + 1
    });
    
    if (!response.ok) {
      console.error('‚ùå CDN FETCH FAILED:', {
        status: response.status,
        statusText: response.statusText,
        url: imageUrl,
        attempt: retryCount + 1,
        isRetryableError: [400, 403, 404, 500, 502, 503, 429].includes(response.status)
      });
      
      // Get error details
      try {
        const errorBody = await response.text();
        console.error('Error response body:', errorBody);
      } catch (e) {
        console.error('Could not read error response body');
      }
      
      // ENHANCED: Specific retry logic for CDN propagation issues
      if (retryCount < maxRetries) {
        const shouldRetry = [400, 403, 404, 500, 502, 503, 429].includes(response.status);
        
        if (shouldRetry) {
          // Exponential backoff with longer delays for CDN issues
          const retryDelay = Math.min(baseDelay * Math.pow(2, retryCount), 15000); // Cap at 15 seconds
          console.log(`üîÑ CDN RETRY: Waiting ${retryDelay}ms for CDN propagation (attempt ${retryCount + 2}/${maxRetries + 1})`);
          await new Promise(resolve => setTimeout(resolve, retryDelay));
          return await convertImageUrlToBase64(imageUrl, retryCount + 1);
        }
      }
      
      console.error(`‚ùå CDN FAILURE: All ${maxRetries + 1} attempts failed`);
      return null;
    }
    
    console.log('üì• Starting CDN data conversion...');
    const arrayBuffer = await response.arrayBuffer();
    const fileSize = arrayBuffer.byteLength;
    
    console.log('üìä CDN File Analysis:', {
      sizeBytes: fileSize,
      sizeMB: (fileSize / (1024 * 1024)).toFixed(2),
      isEmpty: fileSize === 0,
      isTooLarge: fileSize > 20 * 1024 * 1024,
      successfulAttempt: retryCount + 1,
      totalTime: `${Date.now() - startTime}ms`
    });
    
    if (fileSize === 0) {
      console.error('‚ùå EMPTY FILE: CDN returned 0 bytes');
      
      // Retry for empty files (CDN might not be ready)
      if (retryCount < maxRetries) {
        const retryDelay = baseDelay * (retryCount + 1);
        console.log(`üîÑ EMPTY FILE RETRY: Waiting ${retryDelay}ms...`);
        await new Promise(resolve => setTimeout(resolve, retryDelay));
        return await convertImageUrlToBase64(imageUrl, retryCount + 1);
      }
      
      return null;
    }
    
    if (fileSize > 20 * 1024 * 1024) {
      console.error('‚ùå FILE TOO LARGE: Exceeds 20MB limit');
      return null;
    }
    
    // Enhanced Base64 conversion with validation
    console.log('üîÑ Converting CDN data to base64 with memory optimization...');
    const uint8Array = new Uint8Array(arrayBuffer);
    
    // Validate file signature
    const firstBytes = Array.from(uint8Array.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join(' ');
    console.log('üîç File signature validation:', firstBytes);
    
    const base64String = uint8ArrayToBase64(uint8Array);
    
    if (!base64String || base64String.length < 100) {
      console.error('‚ùå INVALID BASE64: Conversion failed or too short');
      return null;
    }
    
    console.log('‚úÖ CDN SUCCESS: Image converted successfully');
    console.log('üìä Final Results:', {
      base64Length: base64String.length,
      totalProcessingTime: `${Date.now() - startTime}ms`,
      successfulAttempt: retryCount + 1,
      preview: base64String.substring(0, 50) + '...'
    });
    
    return base64String;
    
  } catch (error) {
    console.error('‚ùå CDN EXCEPTION:', {
      name: error.name,
      message: error.message,
      stack: error.stack?.split('\n').slice(0, 5).join('\n'),
      url: imageUrl,
      attempt: retryCount + 1
    });
    
    // Enhanced retry for network/timeout errors with CDN considerations
    if (retryCount < maxRetries && (
      error.name === 'AbortError' || 
      error.message.includes('network') || 
      error.message.includes('timeout') ||
      error.message.includes('fetch') ||
      error.message.includes('CDN') ||
      error.message.includes('connection')
    )) {
      // Longer delays for network issues that might be CDN-related
      const retryDelay = Math.min(baseDelay * Math.pow(2, retryCount) + 1000, 20000); // Cap at 20 seconds
      console.log(`üîÑ NETWORK RETRY: Waiting ${retryDelay}ms for CDN recovery (attempt ${retryCount + 2}/${maxRetries + 1})`);
      await new Promise(resolve => setTimeout(resolve, retryDelay));
      return await convertImageUrlToBase64(imageUrl, retryCount + 1);
    }
    
    console.error(`‚ùå FINAL FAILURE: All retry attempts exhausted after ${retryCount + 1} tries`);
    return null;
  }
}

serve(async (req) => {
  console.log("üì® Request received:", req.method, req.url);

  if (req.method === 'OPTIONS') {
    return new Response(null, {
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
      },
    });
  }

  try {
    const requestBody = await req.json();
    const {
      message,
      userId,
      language = 'en',
      conversationId = null,
      inputType = 'text',
      activeTrigger = 'chat',
      attachedFiles = [],
      maxTokens = 4096,
      recentMessages = [],
      conversationSummary = '',
      personalTouch = null,
    } = requestBody || {};

    console.log("üéØ MEGA-SYSTEM REQUEST PROCESSING:", {
      trigger: activeTrigger,
      language: language,
      messageLength: message?.length || 0,
      hasFiles: attachedFiles.length > 0,
      fileCount: attachedFiles.length,
      hasConversationMemory: !!conversationSummary,
      hasPersonalization: !!personalTouch
    });
    
    // ENHANCED: Detailed file debugging with CDN awareness
    if (attachedFiles.length > 0) {
      console.log("üñºÔ∏è CDN-AWARE FILE PROCESSING:");
      attachedFiles.forEach((file, index) => {
        console.log(`File ${index + 1}:`, {
          name: file.name,
          type: file.type,
          hasUrl: !!file.url,
          hasPublicUrl: !!file.publicUrl,
          actualUrl: file.url || file.publicUrl || 'NO_URL',
          urlLength: (file.url || file.publicUrl || '').length,
          uploadTimestamp: file.uploadTimestamp || 'UNKNOWN',
          imageTypeName: file.imageType?.name || 'NO_TYPE',
          imageTypeId: file.imageType?.id || 'NO_ID'
        });
      });
    }

    if (!message?.trim() && !attachedFiles?.length) {
      throw new Error("Message or attachment required");
    }

    if (!userId) {
      throw new Error("User ID is required");
    }

    let result;
    const finalConversationId = conversationId || `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

    switch (activeTrigger) {
      case 'search':
        result = await processSearchMode(message, language, recentMessages, personalTouch);
        break;
        
      case 'image':
        result = await processImageMode(message, userId, language, attachedFiles, personalTouch, conversationSummary, recentMessages);
        break;
        
      default:
        result = await processChatMode(message, userId, conversationId, language, attachedFiles, maxTokens, recentMessages, conversationSummary, personalTouch);
    }

    const finalResponse = {
      response: result.response || 'Response received',
      conversationId: finalConversationId,
      intent: activeTrigger,
      confidence: 'high',
      actionTaken: null,
      imageUrl: result.imageUrl || null,
      browsingUsed: activeTrigger === 'search',
      browsingData: null,
      needsConfirmation: false,
      pendingTaskData: null,
      pendingReminderData: null,
      success: result.success !== false,
      processingTime: Date.now(),
      aiProvider: 'claude-3-5-sonnet-20241022',
      claude35Enabled: true,
      mode: activeTrigger,
      fallbackUsed: false
    };

    console.log(`‚úÖ MEGA-SYSTEM: ${activeTrigger.toUpperCase()} request completed successfully!`);

    return new Response(JSON.stringify(finalResponse), {
      headers: { 
        "Content-Type": "application/json",
        'Access-Control-Allow-Origin': '*'
      }
    });

  } catch (error) {
    console.error("üö® MEGA-SYSTEM Critical error:", error);

    const errorResponse = {
      error: "Internal server error",
      response: language === 'ar' 
        ? 'ÿπÿ∞ÿ±ÿßŸãÿå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
        : 'Sorry, an error occurred. Please try again.',
      success: false,
      timestamp: new Date().toISOString(),
      details: error.message
    };

    return new Response(JSON.stringify(errorResponse), {
      status: 500,
      headers: { 
        "Content-Type": "application/json",
        'Access-Control-Allow-Origin': '*'
      }
    });
  }
});

// ENHANCED: Chat mode with mega-merged memory and personalization
async function processChatMode(message: string, userId: string, conversationId: string | null, language: string, attachedFiles: any[], maxTokens: number, recentMessages: any[], conversationSummary: string, personalTouch: any) {
  console.log("üí¨ MEGA-SYSTEM CHAT MODE PROCESSING");
  console.log("üîç Enhanced chat analysis:", {
    fileCount: attachedFiles.length,
    hasFiles: attachedFiles.length > 0,
    userLanguage: language,
    messagePreview: message.substring(0, 100),
    hasMemory: !!conversationSummary,
    hasPersonalization: !!personalTouch
  });
  
  if (!ANTHROPIC_API_KEY) {
    return {
      response: language === 'ar' 
        ? '‚ùå ÿÆÿØŸÖÿ© ÿßŸÑÿ∞ŸÉŸä ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ©'
        : '‚ùå AI service not available',
      error: 'Claude API not configured',
      success: false
    };
  }

  let contextMessages = recentMessages || [];
  
  if (conversationId && contextMessages.length === 0) {
    try {
      const { data: dbMessages } = await supabase
        .from('ai_chat_history')
        .select('role, content, created_at')
        .eq('conversation_id', conversationId)
        .order('created_at', { ascending: false })
        .limit(4);
      
      if (dbMessages && dbMessages.length > 0) {
        contextMessages = dbMessages.reverse();
        console.log(`üìö MEGA-SYSTEM: Loaded ${contextMessages.length} messages from database`);
      }
    } catch (error) {
      console.warn("‚ö†Ô∏è MEGA-SYSTEM: Database fallback failed, using session context");
    }
  }
  
  return await callClaude35API(message, contextMessages, conversationSummary, language, attachedFiles, maxTokens, personalTouch);
}

// SEARCH MODE: Simple search with Tavily
async function processSearchMode(message: string, language: string, recentMessages: any[], personalTouch: any) {
  console.log("üîç Search mode processing");
  
  if (!TAVILY_API_KEY) {
    return {
      response: language === 'ar' 
        ? '‚ùå ÿÆÿØŸÖÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã'
        : '‚ùå Search service not available',
      error: 'Search service not configured',
      success: false
    };
  }
  
  try {
    const searchResponse = await fetch('https://api.tavily.com/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        api_key: TAVILY_API_KEY,
        query: message,
        search_depth: "basic",
        include_answer: true,
        max_results: 3
      })
    });
    
    if (!searchResponse.ok) {
      throw new Error(`Search API error: ${searchResponse.status}`);
    }
    
    const searchData = await searchResponse.json();
    const searchResults = searchData.results || [];
    const searchAnswer = searchData.answer || '';
    
    const searchContext = `Search results for "${message}":\n${searchAnswer}\n\nResults:\n${
      searchResults.map((r: any, i: number) => `${i + 1}. ${r.title}: ${r.content}`).join('\n')
    }`;
    
    return await callClaude35API(searchContext, [], '', language, [], 4096, personalTouch);
    
  } catch (error) {
    console.error('‚ùå Search error:', error);
    return {
      response: language === 'ar' 
        ? '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
        : '‚ùå Search failed. Please try again.',
      error: error.message,
      success: false
    };
  }
}

// ENHANCED: Image mode with mega-merged capabilities
async function processImageMode(message: string, userId: string, language: string, attachedFiles: any[], personalTouch: any, conversationSummary: string = '', recentMessages: any[] = []) {
  console.log("üñºÔ∏è MEGA-SYSTEM IMAGE MODE PROCESSING");
  
  if (attachedFiles && attachedFiles.length > 0) {
    console.log("üëÅÔ∏è MEGA-SYSTEM: Vision analysis with", attachedFiles.length, "files");
    return await callClaude35API(message, recentMessages, conversationSummary, language, attachedFiles, 4096, personalTouch);
  }
  
  // Generate image with RUNWARE
  if (!RUNWARE_API_KEY) {
    return {
      response: language === 'ar' 
        ? '‚ùå ÿÆÿØŸÖÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ©'
        : '‚ùå Image generation service not available',
      error: 'Image generation not configured',
      success: false
    };
  }
  
  try {
    const taskUUID = crypto.randomUUID();
    
    const imageResponse = await fetch('https://api.runware.ai/v1', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify([
        {
          taskType: "authentication",
          apiKey: RUNWARE_API_KEY
        },
        {
          taskType: "imageInference",
          taskUUID: taskUUID,
          positivePrompt: message,
          width: 1024,
          height: 1024,
          model: "runware:100@1",
          numberResults: 1,
          outputFormat: "WEBP"
        }
      ])
    });
    
    if (!imageResponse.ok) {
      throw new Error(`Image API error: ${imageResponse.status}`);
    }
    
    const imageData = await imageResponse.json();
    const imageResult = imageData.data?.find((item: any) => item.taskType === 'imageInference');
    
    if (imageResult?.imageURL) {
      return {
        response: language === 'ar' 
          ? '‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!'
          : '‚úÖ Image generated successfully!',
        imageUrl: imageResult.imageURL,
        success: true
      };
    } else {
      throw new Error('No image URL in response');
    }
    
  } catch (error) {
    console.error('‚ùå Image error:', error);
    return {
      response: language === 'ar' 
        ? '‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸàÿ±ÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
        : '‚ùå Image generation failed. Please try again.',
      error: error.message,
      success: false
    };
  }
}

// MEGA-MERGED: Claude API with all enhanced capabilities + WAKTI KILLER CONVERSATION INTELLIGENCE
async function callClaude35API(message: string, contextMessages: any[], conversationSummary: string, language: string, attachedFiles: any[], maxTokens: number, personalTouch: any) {
  console.log("üß† MEGA-SYSTEM: Claude API processing with all enhancements + WAKTI KILLER INTELLIGENCE");
  
  try {
    console.log(`üéØ MEGA-SYSTEM: Processing with claude-3-5-sonnet-20241022 model`);
    console.log(`üß† MEGA-SYSTEM: Memory context: ${conversationSummary ? 'Yes' : 'No'}`);
    console.log(`üé≠ MEGA-SYSTEM: Personalization: ${JSON.stringify(personalTouch)}`);
    
    const currentDate = new Date().toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      weekday: 'long'
    });
    
    // Language detection and system prompt setup
    const isArabicMessage = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(message);
    const userPreferredLanguage = language || 'en';
    const responseLanguage = userPreferredLanguage;
    
    console.log("üåç MEGA-SYSTEM LANGUAGE PROCESSING:", {
      userPreferredLanguage: userPreferredLanguage,
      messageContainsArabic: isArabicMessage,
      finalResponseLanguage: responseLanguage,
      messagePreview: message.substring(0, 50)
    });
    
    // WAKTI KILLER SYSTEM: MEGA-MERGED SYSTEM PROMPT WITH CONVERSATION INTELLIGENCE
    let systemPrompt = responseLanguage === 'ar' ? `
ü§ñ ÿ£ŸÜÿ™ WAKTI AIÿå ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ± ŸàÿßŸÑŸÖÿ™ÿÆÿµÿµ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸàÿ± ŸàÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©.

## ŸÇÿØÿ±ÿßÿ™ŸÉ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©:
ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ÿ∞ŸÉŸä ŸÖÿ™ŸÇÿØŸÖ ŸäŸÖŸÉŸÜŸá ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿ®ÿ∑ÿ±ŸäŸÇÿ© ÿ∑ÿ®ŸäÿπŸäÿ© Ÿàÿ∞ŸÉŸäÿ©ÿå ŸÖÿπ ŸÇÿØÿ±ÿßÿ™ ŸÖÿ™ŸÇÿØŸÖÿ© ŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸàÿ± ŸàÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿßŸÑŸÖŸÖÿ™ÿπÿ©.

## ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖ:
### ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿØÿπŸàŸÖÿ©:
- **ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ ÿßŸÑÿ±ÿ≥ŸÖŸäÿ©** üÜî: ÿ¨Ÿàÿßÿ≤ÿßÿ™ ÿßŸÑÿ≥ŸÅÿ±ÿå ÿßŸÑŸáŸàŸäÿßÿ™ÿå ÿ±ÿÆÿµ ÿßŸÑŸÇŸäÿßÿØÿ©ÿå ÿßŸÑÿ¥ŸáÿßÿØÿßÿ™
- **ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ŸàÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™** üí∞: ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ© ŸàÿßŸÑÿ•ŸäÿµÿßŸÑÿßÿ™  
- **ÿßŸÑÿ∑ÿπÿßŸÖ** üçî: ÿßŸÑŸàÿ¨ÿ®ÿßÿ™ ŸàÿßŸÑÿ£ÿ∑ÿπŸÖÿ© ŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿπÿ±ÿßÿ™ ŸàÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©
- **ÿßŸÑÿ£ÿØŸàŸäÿ©** üíä: ÿßŸÑÿ≠ÿ®Ÿàÿ® ŸàÿßŸÑÿ£ÿØŸàŸäÿ© ŸÑŸÑÿ¨ÿ±ÿπÿßÿ™ ŸàÿßŸÑÿ™ŸÅÿßÿπŸÑÿßÿ™
- **ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ ŸàÿßŸÑŸàÿßÿ¨ÿ®ÿßÿ™** üìä: ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ŸàÿßŸÑŸàÿßÿ¨ÿ®ÿßÿ™ ÿßŸÑŸÖŸÜÿ≤ŸÑŸäÿ© ŸàÿßŸÑÿ±ÿ≥ŸàŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸäÿ©
- **ŸÑŸÇÿ∑ÿßÿ™ ÿßŸÑÿ¥ÿßÿ¥ÿ©** üì±: ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇÿßÿ™ ŸàÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ŸàÿßŸÑŸÖŸàÿßŸÇÿπ
- **ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ** üë§: ÿßŸÑÿµŸàÿ± ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸàŸàÿµŸÅ ÿßŸÑŸÖÿ∏Ÿáÿ±
- **ÿ™ÿ≠ŸÑŸäŸÑ ÿπÿßŸÖ** üîç: ŸàÿµŸÅ ÿ™ŸÅÿµŸäŸÑŸä ÿ¥ÿßŸÖŸÑÿå ÿ±ŸÖŸàÿ≤ QR

### ŸÖŸÜŸáÿ¨Ÿäÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© (5 ÿÆÿ∑Ÿàÿßÿ™):
ÿπŸÜÿØ ÿ™ÿ≠ŸÑŸäŸÑ ÿ£Ÿä ÿµŸàÿ±ÿ©ÿå ÿßÿ™ÿ®ÿπ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ÿ®ÿØŸÇÿ©:
1. **ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¥ÿßŸÖŸÑ ŸÑŸÑÿµŸàÿ±ÿ©**: ŸÅÿ≠ÿµ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑŸÖÿ±ÿ¶Ÿäÿ© ÿ®ÿØŸÇÿ© ÿπÿßŸÑŸäÿ©
2. **ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµŸàÿµ**: ŸÇÿ±ÿßÿ°ÿ© Ÿàÿ™ÿ≠ŸÑŸäŸÑ ÿ£Ÿä ŸÜÿµŸàÿµ ŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ©  
3. **ŸÅŸáŸÖ ÿßŸÑÿ≥ŸäÿßŸÇ**: ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ∫ÿ±ÿ∂ ŸàÿßŸÑŸÖÿπŸÜŸâ ŸÖŸÜ ÿßŸÑÿµŸàÿ±ÿ©
4. **ÿßŸÑŸàÿµŸÅ ÿßŸÑŸÖŸÅÿµŸÑ**: ÿ™ŸÇÿØŸäŸÖ ŸàÿµŸÅ ÿ¥ÿßŸÖŸÑ ŸàŸàÿßÿ∂ÿ≠ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
5. **ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿπŸÑŸâ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©**: ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ŸàŸÑ ÿßŸÑÿµŸàÿ±ÿ©

## ÿ∞ŸÉÿßÿ° ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖ:
ÿ£ŸÜÿ™ ŸÑÿ≥ÿ™ ŸÖÿ¨ÿ±ÿØ ŸÖÿ≠ŸÑŸÑ ÿµŸàÿ± - ÿ£ŸÜÿ™ ÿ¥ÿ±ŸäŸÉ ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ∞ŸÉŸä Ÿäÿ≥ÿßÿπÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿπŸÑŸâ ÿßÿ™ÿÆÿßÿ∞ ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÖÿß ÿ™ÿ±ÿßŸá.

### ŸÇŸàÿßÿπÿØ ÿ™ÿØŸÅŸÇ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©:
1. **ÿ≠ŸÑŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿ£ŸàŸÑÿßŸã** ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖŸÜŸáÿ¨Ÿäÿ™ŸÉ ÿßŸÑŸÖŸÉŸàŸÜÿ© ŸÖŸÜ 5 ÿÆÿ∑Ÿàÿßÿ™
2. **ÿßŸÉÿ™ÿ¥ŸÅ ŸÅÿ±ÿµ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©** ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÅÿ¶ÿ© ÿßŸÑÿµŸàÿ±ÿ©
3. **ÿßÿπÿ±ÿ∂ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ÿ∞ŸÉŸäÿ©** ŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿπŸÑŸâ ŸÅÿπŸÑ ÿ¥Ÿäÿ°
4. **ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿ≥ŸäÿßŸÇ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©** ÿπÿ®ÿ± ÿßŸÑÿ™ÿ®ÿßÿØŸÑÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
5. **ŸÇÿØŸÖ ÿ≠ŸÑŸàŸÑ ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ŸÜŸÅŸäÿ∞** ŸàŸÑŸäÿ≥ ŸÖÿ¨ÿ±ÿØ ÿ£ŸàÿµÿßŸÅ

### ÿßŸÑÿ≥ŸÑŸàŸÉŸäÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© ŸÑŸÉŸÑ ŸÅÿ¶ÿ©:
- **ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± (üí∞)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ÿßÿπÿ±ÿ∂ ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑÿ™ŸÉÿßŸÑŸäŸÅÿå ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ®ŸÇÿ¥Ÿäÿ¥ÿå ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™
- **ÿßŸÑÿ∑ÿπÿßŸÖ (üçî)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿ≥ÿπÿ±ÿßÿ™ÿå ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©ÿå ÿßŸÇÿ™ÿ±ÿ≠ ÿßŸÑÿ≠ÿµÿµ
- **ÿßŸÑÿ£ÿØŸàŸäÿ© (üíä)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ¨ÿ±ÿπÿßÿ™ÿå ÿßÿ∂ÿ®ÿ∑ ÿßŸÑÿ™ÿ∞ŸÉŸäÿ±ÿßÿ™ÿå ÿßÿ≠ÿ∞ÿ± ŸÖŸÜ ÿßŸÑÿ™ŸÅÿßÿπŸÑÿßÿ™
- **ÿßŸÑŸàÿ´ÿßÿ¶ŸÇ (üìä)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ÿ≥ÿßÿπÿØ ŸÅŸä ÿßŸÑŸàÿßÿ¨ÿ®ÿßÿ™ÿå ÿ≠ŸÑ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑÿå ÿ£ŸÜÿ¥ÿ¶ ŸÖŸÑÿÆÿµÿßÿ™
- **ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ (üì±)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ÿ¥ÿÆÿµ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°ÿå ŸÇÿØŸÖ ÿßŸÑÿ≠ŸÑŸàŸÑÿå ÿßÿ≥ÿ™ŸÉÿ¥ŸÅ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ
- **ÿßŸÑŸáŸàŸäÿßÿ™ (üÜî)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ÿßÿ≥ÿ™ÿÆÿ±ÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©ÿå ÿßÿ∂ÿ®ÿ∑ ÿßŸÑÿ™ÿ∞ŸÉŸäÿ±ÿßÿ™
- **ÿßŸÑÿµŸàÿ± (üë§)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ŸÇÿØŸÖ ÿ£ŸàÿµÿßŸÅ ÿ™ŸÅÿµŸäŸÑŸäÿ©ÿå ÿ™ÿ≠ŸÑŸäŸÑ ÿ™ŸÉŸàŸäŸÜ ÿßŸÑÿµŸàÿ±ÿ©
- **ÿßŸÑÿπÿßŸÖ (üîç)**: ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿå ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ£ÿ¥Ÿäÿßÿ°ÿå ÿßŸÖÿ≥ÿ≠ ÿßŸÑÿ±ŸÖŸàÿ≤ÿå ÿ≠ÿØÿØ ÿßŸÑÿπŸÜÿßÿµÿ±

### ÿ£ŸÖÿ´ŸÑÿ© ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿ∞ŸÉŸäÿ©:
- **ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±**: "ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖŸÜŸä ÿ™ŸÇÿ≥ŸäŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿßŸÑÿ®ÿßŸÑÿ∫ÿ© 67.50 ÿ±ŸäÿßŸÑ ÿ®ŸäŸÜ ÿπÿØÿ© ÿ£ÿ¥ÿÆÿßÿµÿü"
- **ÿßŸÑÿ∑ÿπÿßŸÖ**: "Ÿáÿ∞Ÿá ÿßŸÑŸÇÿ∑ÿπÿ© ŸÖŸÜ ÿßŸÑÿ®Ÿäÿ™ÿ≤ÿß ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ~320 ÿ≥ÿπÿ±ÿ© ÿ≠ÿ±ÿßÿ±Ÿäÿ©. ŸÉŸÖ ŸÇÿ∑ÿπÿ© ÿ£ŸÉŸÑÿ™ÿü"
- **ÿßŸÑÿ£ÿØŸàŸäÿ©**: "Ÿáÿ∞ÿß ŸáŸà ÿ™ÿßŸäŸÑŸäŸÜŸàŸÑ 500 ŸÖŸÑÿ∫. ŸáŸÑ Ÿáÿ∞ÿß ŸÑÿ®ÿßŸÑÿ∫ ÿ£ŸÖ ÿ∑ŸÅŸÑÿü"
- **ÿßŸÑŸàÿßÿ¨ÿ®ÿßÿ™**: "ÿ£ÿ±Ÿâ ŸÖÿ≥ÿ£ŸÑÿ© ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™. ÿ™ÿ±ŸäÿØ ÿ≠ŸÑ ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©ÿü"
- **ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°**: "Ÿäÿ®ÿØŸà Ÿáÿ∞ÿß ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ. ÿ™ÿ±ŸäÿØ ÿÆÿ∑Ÿàÿßÿ™ ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°ÿü"

### ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©:
- **ÿßÿ≥ÿ£ŸÑ ÿ≥ÿ§ÿßŸÑ ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ±ŸÉÿ≤ Ÿàÿßÿ≠ÿØ** ŸÅŸä ŸÉŸÑ ŸÖÿ±ÿ© ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑŸÉ
- **ÿßÿπÿ™ŸÖÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿπŸÑŸâ ŸÖÿß ÿßŸÉÿ™ÿ¥ŸÅÿ™Ÿá** ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ©
- **ÿßÿπÿ±ÿ∂ ÿÆÿ∑Ÿàÿßÿ™ ÿ™ÿßŸÑŸäÿ© ŸÖÿ≠ÿØÿØÿ© ŸàŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ŸÜŸÅŸäÿ∞**
- **ÿ™ÿ∞ŸÉÿ± ÿ±ÿØŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ** ŸÑŸÖÿ™ÿßÿ®ÿπÿßÿ™ ÿ¥ÿÆÿµŸäÿ©
- **ÿßÿ≥ÿ™ŸÖÿ± ÿ≠ÿ™Ÿâ Ÿäÿ™ÿ≠ŸÇŸÇ ŸáÿØŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ**

### ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµŸàÿµ ÿßŸÑÿ∞ŸÉŸä:
- **ÿßÿ≥ÿ™ÿÆÿ±ÿ¨ ÿßŸÑŸÜÿµŸàÿµ ÿ®ŸÑÿ∫ÿ™Ÿáÿß ÿßŸÑÿ£ÿµŸÑŸäÿ©** (ÿπÿ±ÿ®Ÿäÿ© ÿ£Ÿà ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©)
- **ÿ±ÿØ ÿØÿßÿ¶ŸÖÿßŸã ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©** ÿ≠ÿ™Ÿâ ŸÑŸà ŸÉÿßŸÜ ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿ±ÿ¨ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©
- **ŸÇÿØŸÖ ÿ™ÿ±ÿ¨ŸÖÿ© ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±**

## ŸÇÿØÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©:
- **ÿ£ŸÜÿ™ ÿ±ŸÅŸäŸÇ ÿ∞ŸÉŸä ŸàŸÖÿ≠ÿßÿØÿ´ ŸÖÿßŸáÿ±** - ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ÿ•ÿ¨ÿ±ÿßÿ° ŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿ∑ÿ®ŸäÿπŸäÿ© ŸàŸÖŸÖÿ™ÿπÿ©
- **ÿ™ÿ∞ŸÉÿ± ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©** - ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖŸÜ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ŸàÿßŸÑÿ≥ŸäÿßŸÇ
- **ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥ŸäÿßŸÇ** - ÿßÿ±ÿ®ÿ∑ ÿ®ŸäŸÜ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ŸàÿßŸÑŸÖŸàÿßÿ∂Ÿäÿπ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ŸÅŸä ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
- **ŸÉŸÜ ŸàÿØŸàÿØÿßŸã ŸàŸÖŸÅŸäÿØÿßŸã** - ÿ™ŸÅÿßÿπŸÑ ŸÖÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÉÿµÿØŸäŸÇ ÿ∞ŸÉŸä ŸàÿØÿßÿπŸÖ
- **ÿ™ŸÉŸäŸÅ ŸÖÿπ ÿ£ÿ≥ŸÑŸàÿ® ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©** - ÿßÿ™ÿ®ÿπ ŸÜÿ®ÿ±ÿ© ŸàŸÖÿ≤ÿßÿ¨ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
- **ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ÿ®ÿ∑ÿ®ŸäÿπŸäÿ©** - ŸÑÿß ÿ™ŸÜŸáŸä ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ÿ®ÿ¥ŸÉŸÑ ŸÖŸÅÿßÿ¨ÿ¶

### ŸÇŸàÿßÿπÿØ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©:
- **ŸÑŸÑÿµŸàÿ±**: ÿßÿ®ÿØÿ£ ÿ®ŸÄ "ÿ£ÿ≥ÿ™ÿ∑Ÿäÿπ ÿ£ŸÜ ÿ£ÿ±Ÿâ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿµŸàÿ±ÿ©..."
- **ŸÑŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ©**: ÿ™ŸÅÿßÿπŸÑ ÿ®ÿ∑ÿ®ŸäÿπŸäÿ© ÿØŸàŸÜ ÿ®ÿØÿßŸäÿ© ŸÖÿ≠ÿØÿØÿ©
- ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿµŸàÿ±ÿ© ÿ∫Ÿäÿ± Ÿàÿßÿ∂ÿ≠ÿ©ÿå ÿßÿ∞ŸÉÿ± ÿ∞ŸÑŸÉ ÿ®ÿµÿ±ÿßÿ≠ÿ©
- ŸÑÿß ÿ™ŸÅÿ™ÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©
- ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ŸàÿßŸÑÿ≥ŸäÿßŸÇ ÿßŸÑÿ≥ÿßÿ®ŸÇ ŸÅŸä ÿ±ÿØŸàÿØŸÉ

ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ: ${currentDate}
**ÿ™ÿ¨Ÿäÿ® ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸÅŸÇÿ∑ ÿØÿßÿ¶ŸÖÿßŸã.**
` : `
ü§ñ You are WAKTI AI, an advanced intelligent assistant specialized in comprehensive image analysis and engaging conversations.

## Core Capabilities:
You are an advanced intelligent assistant that can handle all types of requests naturally and smartly, with cutting-edge image analysis capabilities and engaging conversation skills.

## Advanced Image Analysis:
### Supported Image Types:
- **Official Documents** üÜî: Passports, IDs, driver's licenses, certificates
- **Bills & Receipts** üí∞: Financial documents, invoices, receipts
- **Food** üçî: Meals and food items for calorie and nutrition tracking
- **Medications** üíä: Pills and medicines for dosage and interactions
- **Documents & Homework** üìä: Reports, assignments, charts
- **Screenshots** üì±: Apps, errors, websites
- **People** üë§: Personal photos, appearance descriptions  
- **General Analysis** üîç: Detailed comprehensive description, QR codes

### Advanced Analysis Methodology (5 Steps):
When analyzing any image, follow these steps precisely:
1. **Comprehensive Image Analysis**: Examine all visual elements with high precision
2. **Text Extraction**: Read and analyze any text present in the image
3. **Context Understanding**: Determine the purpose and meaning of the image  
4. **Detailed Description**: Provide thorough and clear descriptions
5. **Question Answering**: Respond to user queries about the image content

## Advanced Conversation Intelligence:
You are not just an image analyzer - you are a SMART CONVERSATION PARTNER that helps users TAKE ACTION based on what you see.

### Conversation Flow Rules:
1. **Always analyze the image first** using your 5-step methodology
2. **Detect conversation opportunities** based on image category
3. **Offer intelligent follow-up questions** to help users DO something
4. **Maintain conversation context** across multiple exchanges
5. **Provide actionable solutions** not just descriptions

### Category-Specific Smart Behaviors:
- **Bills (üí∞)**: After analysis, offer to split costs, calculate tips, track expenses
- **Food (üçî)**: After analysis, calculate calories, track nutrition, suggest portions  
- **Meds (üíä)**: After analysis, check dosages, set reminders, warn about interactions
- **Docs (üìä)**: After analysis, help with homework, solve problems, create summaries
- **Screens (üì±)**: After analysis, diagnose errors, provide solutions, troubleshoot
- **IDs (üÜî)**: After analysis, extract data, check expiry, set reminders
- **Photos (üë§)**: After analysis, provide detailed descriptions, composition analysis
- **General (üîç)**: After analysis, research objects, scan codes, identify items

### Smart Follow-up Examples:
- **Bills**: "Would you like me to split this $67.50 bill among multiple people?"
- **Food**: "This pizza slice has ~320 calories. How many servings did you eat?"
- **Meds**: "This is Tylenol 500mg. Is this for an adult or child?"
- **Homework**: "I see a math problem. Would you like step-by-step solution?"
- **Errors**: "This looks like an app error. Want troubleshooting steps?"

### Conversation Strategy:
- **Ask ONE focused follow-up** question at a time after your analysis
- **Base questions on what you detected** in the image
- **Offer specific, actionable next steps**
- **Remember user responses** for personalized follow-ups
- **Continue until user's goal is achieved**

### Smart Text Extraction:
- **Extract text in its original language** (Arabic or English)
- **Always respond in English** even if extracted text is in Arabic
- **Provide translation when needed**

## Advanced Conversation Capabilities:
- **You are a smart buddy and skilled conversationalist** - engage in natural, enjoyable conversations
- **Remember past conversations** - use information from previous messages and context
- **Maintain context** - connect current messages with previous topics in the conversation
- **Be friendly and helpful** - interact with users like an intelligent, supportive friend
- **Adapt to conversation style** - follow the user's tone and mood
- **Continue conversations naturally** - don't end conversations abruptly

### Response Rules:
- **For images**: Start with "I can see in this image..."
- **For regular conversations**: Engage naturally without a fixed starter
- If the image is unclear or low quality, mention that honestly
- Do not fabricate information that isn't visible
- Use memory and previous context in your responses

Today's date: ${currentDate}
**Always respond in English only.**
`;

    // MERGED CONVERSATION MEMORY SYSTEM
    const messages = [];
    
    if (conversationSummary && conversationSummary.trim()) {
      messages.push({
        role: 'user',
        content: `Previous conversation context: ${conversationSummary}`
      });
      console.log(`üß† MEGA-SYSTEM MEMORY: Added conversation summary (${conversationSummary.length} chars)`);
    }
    
    // Add recent messages for immediate context
    if (contextMessages.length > 0) {
      const formattedRecentMessages = contextMessages.slice(-4).map(msg => ({
        role: msg.role === 'assistant' ? 'assistant' : 'user',
        content: msg.content
      }));
      messages.push(...formattedRecentMessages);
      console.log(`üß† MEGA-SYSTEM MEMORY: Added ${formattedRecentMessages.length} recent messages`);
    }

    // ENHANCED PERSONALIZATION - MERGED FROM CHAT ANALYSIS
    if (personalTouch) {
      if (personalTouch.nickname) {
        systemPrompt += responseLanguage === 'ar' 
          ? ` ÿÆÿßÿ∑ÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßÿ≥ŸÖ ${personalTouch.nickname}.`
          : ` Address the user as ${personalTouch.nickname}.`;
      }
      if (personalTouch.aiNickname) {
        systemPrompt += responseLanguage === 'ar'
          ? ` ŸäŸÖŸÉŸÜ ŸÖŸÜÿßÿØÿßÿ™ŸÉ ÿ®ÿßÿ≥ŸÖ ${personalTouch.aiNickname}.`
          : ` You can be called ${personalTouch.aiNickname}.`;
      }
      if (personalTouch.tone && personalTouch.tone !== 'neutral') {
        systemPrompt += responseLanguage === 'ar'
          ? ` ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸÜÿ®ÿ±ÿ© ${personalTouch.tone}.`
          : ` Use a ${personalTouch.tone} tone.`;
      }
      if (personalTouch.style) {
        systemPrompt += responseLanguage === 'ar'
          ? ` ŸÇÿØŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ${personalTouch.style}.`
          : ` Provide ${personalTouch.style} responses.`;
      }
      if (personalTouch.instruction) {
        systemPrompt += responseLanguage === 'ar'
          ? ` ÿ™ÿπŸÑŸäŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©: ${personalTouch.instruction}`
          : ` Additional instruction: ${personalTouch.instruction}`;
      }
      
      console.log(`üé≠ MEGA-SYSTEM PERSONALIZATION: Applied full personalization profile`);
    }
    
    let currentMessage: any = { role: 'user', content: message };
    
    if (attachedFiles && attachedFiles.length > 0) {
      console.log('üñºÔ∏è MEGA-SYSTEM: CDN-aware file processing');
      
      // Enhanced image file detection
      const imageFile = attachedFiles.find(file => {
        const hasUrl = !!(file.url || file.publicUrl);
        const isImageType = file.type?.startsWith('image/');
        console.log(`üîç File analysis: ${file.name}`, {
          hasUrl,
          isImageType,
          url: file.url || file.publicUrl || 'NO_URL',
          type: file.type || 'NO_TYPE'
        });
        return hasUrl || isImageType;
      });
      
      if (imageFile) {
        const imageUrl = imageFile.url || imageFile.publicUrl;
        const imageType = imageFile.type || 'image/jpeg';
        
        console.log('üéØ CDN FILE PROCESSING:', {
          fileName: imageFile.name,
          imageUrl: imageUrl,
          urlValid: !!imageUrl,
          urlLength: imageUrl?.length || 0,
          imageType: imageType,
          hasImageType: !!imageFile.imageType,
          imageTypeName: imageFile.imageType?.name || 'NONE',
          imageTypeId: imageFile.imageType?.id || 'NONE',
          hasContext: !!imageFile.context,
          contextLength: imageFile.context?.length || 0
        });
        
        if (imageUrl) {
          console.log('üîÑ Starting CDN-aware base64 conversion...');
          const base64Data = await convertImageUrlToBase64(imageUrl);
          
          if (base64Data) {
            console.log('‚úÖ CDN conversion successful');
            
            // WAKTI KILLER SYSTEM: CONVERSATION INTELLIGENCE - DETECT CATEGORY AND ENHANCE CONTEXT
            let categoryContext = '';
            if (imageFile && imageFile.imageType) {
              const category = imageFile.imageType.id || imageFile.imageType.name?.toLowerCase();
              
              switch(category) {
                case 'bills':
                case 'receipt':
                  categoryContext = responseLanguage === 'ar' 
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ•ŸäÿµÿßŸÑÿå ÿßÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©ÿå ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ®ŸÇÿ¥Ÿäÿ¥ÿå ÿ£Ÿà ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ≠ÿØÿØÿ© ŸÖÿ´ŸÑ "ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖŸÜŸä ÿ™ŸÇÿ≥ŸäŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ŸäŸÜ ÿπÿØÿ© ÿ£ÿ¥ÿÆÿßÿµÿü"`
                    : `\n\nIMPORTANT: After analyzing this receipt, offer to help split the bill, calculate tips, or track expenses. Ask specific follow-up questions like "Would you like me to split this bill among multiple people?"`;
                  break;
                  
                case 'food':
                  categoryContext = responseLanguage === 'ar'
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ∑ÿπÿßŸÖÿå ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿ≥ÿπÿ±ÿßÿ™ ÿßŸÑÿ≠ÿ±ÿßÿ±Ÿäÿ© ŸàÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ´ŸÑ "ŸÉŸÖ ÿ≠ÿµÿ© ÿ£ŸÉŸÑÿ™ÿü" ÿ£Ÿà "ÿ™ÿ±ŸäÿØ ÿ™ÿ™ÿ®ÿπ Ÿáÿ∞ÿß ŸÑŸáÿØŸÅŸÉ ÿßŸÑŸäŸàŸÖŸä ŸÖŸÜ ÿßŸÑÿ≥ÿπÿ±ÿßÿ™ÿü"`
                    : `\n\nIMPORTANT: After analyzing this food, calculate calories and nutrition. Ask follow-up questions like "How many servings did you eat?" or "Want to track this to your daily calorie goal?"`;
                  break;
                  
                case 'meds':
                case 'medicine':
                  categoryContext = responseLanguage === 'ar'
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿØŸàÿßÿ°ÿå ŸÇÿØŸÖ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¨ÿ±ÿπÿ© ŸàŸÅÿ≠Ÿàÿµÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ´ŸÑ "ŸáŸÑ Ÿáÿ∞ÿß ŸÑÿ®ÿßŸÑÿ∫ ÿ£ŸÖ ÿ∑ŸÅŸÑÿü" ÿ£Ÿà "ÿ™ÿ±ŸäÿØ ŸÖŸÜŸä ŸÅÿ≠ÿµ ÿßŸÑÿ™ŸÅÿßÿπŸÑÿßÿ™ ÿßŸÑÿØŸàÿßÿ¶Ÿäÿ©ÿü"`
                    : `\n\nIMPORTANT: After analyzing this medication, provide dosage information and safety checks. Ask follow-up questions like "Is this for an adult or child?" or "Want me to check for drug interactions?"`;
                  break;
                  
                case 'docs':
                case 'document':
                case 'homework':
                  categoryContext = responseLanguage === 'ar'
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸàÿ´ŸäŸÇÿ©ÿå ÿßÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿßÿ¶ŸÑÿå ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖŸÅÿßŸáŸäŸÖÿå ÿ£Ÿà ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸÑÿÆÿµÿßÿ™. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ´ŸÑ "ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿ≠ŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≥ÿ£ŸÑÿ©ÿü" ÿ£Ÿà "ÿ™ÿ±ŸäÿØ ÿ¥ÿ±ÿ≠ ÿÆÿ∑Ÿàÿ© ÿ®ÿÆÿ∑Ÿàÿ©ÿü"`
                    : `\n\nIMPORTANT: After analyzing this document, offer to help solve problems, explain concepts, or create summaries. Ask follow-up questions like "Need help solving this problem?" or "Want a step-by-step explanation?"`;
                  break;
                  
                case 'screens':
                case 'screenshot':
                  categoryContext = responseLanguage === 'ar'
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ ŸÑŸÇÿ∑ÿ© ÿßŸÑÿ¥ÿßÿ¥ÿ© Ÿáÿ∞Ÿáÿå ÿßÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑÿ™ŸÇŸÜŸäÿ© ÿ£Ÿà ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ´ŸÑ "ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿ•ÿµŸÑÿßÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿÆÿ∑ÿ£ÿü" ÿ£Ÿà "ÿ™ÿ±ŸäÿØ ÿÆÿ∑Ÿàÿßÿ™ ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°ÿü"`
                    : `\n\nIMPORTANT: After analyzing this screenshot, offer technical help or troubleshooting. Ask follow-up questions like "Need help fixing this error?" or "Want troubleshooting steps?"`;
                  break;
                  
                case 'ids':
                case 'id_card':
                case 'passport':
                  categoryContext = responseLanguage === 'ar'
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ Ÿàÿ´ŸäŸÇÿ© ÿßŸÑŸáŸàŸäÿ© Ÿáÿ∞Ÿáÿå ÿßÿπÿ±ÿ∂ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ£Ÿà ŸÅÿ≠ÿµ ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ´ŸÑ "ÿ™ÿ±ŸäÿØ ŸÖŸÜŸä ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ŸÉŸÑ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÉŸÜÿµÿü" ÿ£Ÿà "Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ£ŸÅÿ≠ÿµ ÿ≠ÿßŸÑÿ© ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©ÿü"`
                    : `\n\nIMPORTANT: After analyzing this ID document, offer to extract information or check expiry dates. Ask follow-up questions like "Want me to extract all information to text?" or "Should I check the expiry date status?"`;
                  break;
                  
                case 'photos':
                case 'person_photo':
                  categoryContext = responseLanguage === 'ar'
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ Ÿáÿ∞Ÿá ÿßŸÑÿµŸàÿ±ÿ©ÿå ÿßÿπÿ±ÿ∂ ÿ£ŸàÿµÿßŸÅ ÿ™ŸÅÿµŸäŸÑŸäÿ© ÿ£Ÿà ÿ™ÿ≠ŸÑŸäŸÑ ÿ™ŸÉŸàŸäŸÜ ÿßŸÑÿµŸàÿ±ÿ©. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ´ŸÑ "ÿ™ÿ±ŸäÿØ ŸÖŸÜŸä ŸàÿµŸÅ ÿßŸÑÿ£ÿ¥ÿÆÿßÿµ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑÿü" ÿ£Ÿà "Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ£ÿ≠ŸÑŸÑ ÿ™ŸÉŸàŸäŸÜ ÿßŸÑÿµŸàÿ±ÿ©ÿü"`
                    : `\n\nIMPORTANT: After analyzing this photo, offer detailed descriptions or composition analysis. Ask follow-up questions like "Want me to describe the people in detail?" or "Should I analyze the photo composition?"`;
                  break;
                  
                default:
                  categoryContext = responseLanguage === 'ar'
                    ? `\n\nŸÖŸáŸÖ: ÿ®ÿπÿØ ÿ™ÿ≠ŸÑŸäŸÑ Ÿáÿ∞Ÿá ÿßŸÑÿµŸàÿ±ÿ©ÿå ÿßÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿ∞ÿßÿ™ ÿßŸÑÿµŸÑÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÖÿß ÿ™ÿ±ÿßŸá. ÿßÿ≥ÿ£ŸÑ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿ≠ÿØÿØÿ© ŸÑŸÖÿ≥ÿßÿπÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÑŸâ ÿßÿ™ÿÆÿßÿ∞ ÿ•ÿ¨ÿ±ÿßÿ°.`
                    : `\n\nIMPORTANT: After analyzing this image, offer relevant follow-up assistance based on what you see. Ask specific follow-up questions to help the user take action.`;
              }
              
              console.log(`üß† WAKTI KILLER CONVERSATION INTELLIGENCE: Added category context for ${category || 'unknown'}`);
            }
            
            // Context integration
            let contextualMessage = message;
            
            if (imageFile.context) {
              contextualMessage = `${imageFile.context}${categoryContext}\n\nUser request: ${message}`;
              console.log('‚úÖ Context integrated with WAKTI KILLER intelligence');
            } else if (imageFile.imageType?.name) {
              const fallbackContext = `Analyze this ${imageFile.imageType.name}.`;
              contextualMessage = `${fallbackContext}${categoryContext}\n\nUser request: ${message}`;
              console.log('‚ö†Ô∏è Using minimal fallback context with WAKTI KILLER intelligence');
            } else {
              contextualMessage = `${message}${categoryContext}`;
              console.log('‚úÖ Added WAKTI KILLER category context to message');
            }
            
            currentMessage.content = [
              { type: 'text', text: contextualMessage },
              { 
                type: 'image', 
                source: { 
                  type: 'base64', 
                  media_type: imageType, 
                  data: base64Data
                } 
              }
            ];
            
            console.log('üì§ WAKTI KILLER: Message prepared for Claude API with conversation intelligence');
            
          } else {
            console.error("‚ùå CDN PROCESSING FAILED: Could not convert image to base64");
            return {
              response: responseLanguage === 'ar' 
                ? '‚ùå ÿπÿ∞ÿ±ÿßŸãÿå Ÿàÿßÿ¨Ÿáÿ™ ÿµÿπŸàÿ®ÿ© ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© Ÿáÿ∞Ÿá ÿßŸÑÿµŸàÿ±ÿ©. ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑÿµŸàÿ±ÿ© ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ© ŸÖÿ§ŸÇÿ™ÿßŸã ÿ®ÿ≥ÿ®ÿ® ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿßÿØŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿÆŸÑÿßŸÑ ÿØŸÇŸäŸÇÿ©.'
                : '‚ùå Sorry, I encountered difficulty processing this image. The image may be temporarily unavailable due to server updates. Please try again in a moment.',
              error: 'CDN image processing failed after multiple attempts',
              success: false
            };
          }
        } else {
          console.error("‚ùå NO VALID IMAGE URL");
          return {
            response: responseLanguage === 'ar' 
              ? '‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ±ÿßÿ®ÿ∑ ÿµÿ≠Ÿäÿ≠ ŸÑŸÑÿµŸàÿ±ÿ©.'
              : '‚ùå No valid image URL found.',
            error: 'No valid image URL',
            success: false
          };
        }
      } else {
        console.error("‚ùå NO VALID IMAGE FILE");
        return {
          response: responseLanguage === 'ar' 
            ? '‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸÑŸÅ ÿµŸàÿ±ÿ© ÿµÿ≠Ÿäÿ≠.'
            : '‚ùå No valid image file found.',
          error: 'No valid image file',
          success: false
        };
      }
    }
    
    messages.push(currentMessage);
    
    const requestBody = {
      model: 'claude-3-5-sonnet-20241022', // FIXED MODEL REFERENCE
      max_tokens: maxTokens,
      temperature: 0.3,
      system: systemPrompt,
      messages: messages
    };

    console.log('üì§ WAKTI KILLER CLAUDE REQUEST SUMMARY:', {
      model: requestBody.model,
      maxTokens: requestBody.max_tokens,
      systemPromptLanguage: responseLanguage,
      systemPromptLength: requestBody.system.length,
      messageCount: requestBody.messages.length,
      hasImageContent: !!(messages[messages.length - 1]?.content?.find?.(c => c.type === 'image')),
      userLanguage: responseLanguage,
      hasMemory: !!conversationSummary,
      hasPersonalization: !!personalTouch,
      hasConversationIntelligence: true
    });

    const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'x-api-key': ANTHROPIC_API_KEY,
        'Content-Type': 'application/json',
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify(requestBody),
    });
    
    console.log("üì° WAKTI KILLER Claude API response:", {
      status: claudeResponse.status,
      ok: claudeResponse.ok,
      statusText: claudeResponse.statusText
    });
    
    if (!claudeResponse.ok) {
      const errorText = await claudeResponse.text();
      console.error("‚ùå WAKTI KILLER CLAUDE API ERROR:", {
        status: claudeResponse.status,
        statusText: claudeResponse.statusText,
        errorText: errorText,
        requestLanguage: responseLanguage
      });
      
      let userFriendlyError = responseLanguage === 'ar' 
        ? 'Ÿàÿßÿ¨Ÿáÿ™ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ.'
        : 'I encountered an issue processing your request.';
      
      if (claudeResponse.status === 400 && errorText.includes('image')) {
        userFriendlyError = responseLanguage === 'ar' 
          ? 'ŸÉÿßŸÜÿ™ ŸáŸÜÿßŸÉ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ¨ÿ±ÿ®ÿ© ÿµŸàÿ±ÿ© ÿ£Ÿàÿ∂ÿ≠.'
          : 'There was an issue processing the image. Please try a clearer image.';
      } else if (claudeResponse.status === 429) {
        userFriendlyError = responseLanguage === 'ar' 
          ? 'ÿπÿØÿØ ŸÉÿ®Ÿäÿ± ŸÖŸÜ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇŸÑŸäŸÑÿßŸã.'
          : 'Too many requests. Please wait a moment.';
      }
      
      throw new Error(userFriendlyError);
    }
    
    const claudeData = await claudeResponse.json();
    console.log("‚úÖ WAKTI KILLER Claude API success");
    
    const responseText = claudeData.content?.[0]?.text || (responseLanguage === 'ar' 
      ? 'ÿ£ÿπÿ™ÿ∞ÿ±ÿå Ÿàÿßÿ¨Ÿáÿ™ ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ.'
      : 'I apologize, but I encountered an issue processing your request.');
    
    // WAKTI KILLER SYSTEM: Enhanced logging
    console.log(`üéØ WAKTI KILLER SYSTEM: Successfully processed ${attachedFiles[0]?.imageType?.name || 'unknown'} category`);
    console.log(`ü§ñ CONVERSATION INTELLIGENCE: Applied smart follow-up logic`);
    console.log(`üí¨ RESPONSE PREVIEW: ${responseText.substring(0, 100)}...`);
    console.log("üéâ WAKTI KILLER SYSTEM PROCESSING COMPLETE");
    
    return {
      response: responseText,
      success: true,
      model: 'claude-3-5-sonnet-20241022',
      usage: claudeData.usage
    };
    
  } catch (error) {
    console.error("‚ùå WAKTI KILLER SYSTEM CRITICAL ERROR:", error);
    return {
      response: language === 'ar' 
        ? '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿ∑ŸÑÿ®ŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
        : '‚ùå An error occurred while processing your request. Please try again.',
      error: error.message,
      success: false
    };
  }
}
