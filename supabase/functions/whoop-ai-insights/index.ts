import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-supabase-authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
};

serve(async (req: Request) => {
  try {
    if (req.method === "OPTIONS") return new Response("ok", { headers: corsHeaders });
    if (req.method !== "POST") return new Response("Method Not Allowed", { status: 405, headers: corsHeaders });

    const DEEPSEEK_API_KEY = Deno.env.get("DEEPSEEK_API_KEY");
    if (!DEEPSEEK_API_KEY) {
      return new Response(JSON.stringify({ error: "missing_deepseek_key" }), { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } });
    }

    const body = await req.json().catch(() => ({}));
    if (body?.ping) {
      return new Response(JSON.stringify({ ok: true, service: "whoop-ai-insights" }), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
    }
    const payload = body?.data ?? {};
    const language = body?.language ?? "en";
    const timeOfDay = body?.time_of_day ?? "general";
    const userTimezone = body?.user_timezone ?? "UTC";

    // Enhanced system prompt with time-specific coaching
    const getSystemPrompt = (timeOfDay: string, language: string) => {
      const morningPrompt = language === 'ar' 
        ? `ุฃูุช WAKTI AI - ูุฏุฑุจ ุตุญุฉ ุดุฎุตู ูุชูุฏู ููุชุฎุตุต ูู ุชุญููู ุจูุงูุงุช WHOOP.

๐ ูุถุน ุงูุตุจุงุญ (5-11 ุตุจุงุญูุง) - ุชูููู ุงูุชุนุงูู ูุงูุงุณุชุนุฏุงุฏ:

ุชุญููู ุนููู ูุทููุจ:
- ุชุญููู ุฌูุฏุฉ ุงูููู: ุณุงุนุงุช ุงูููู ุงููุนููุฉ ููุงุจู ุงููุฏูุ ูุฑุงุญู ุงูููู (ุนููู/REM/ุฎููู)
- ุชูููู HRV: ุชูุณูุฑ ููู HRV ููุง ุชุนููู ูุญุงูุฉ ุงูุชุนุงูู
- ูุชูุฌุฉ ุงูุฃุฏุงุก: ุฑุจุท ูุชูุฌุฉ ุงูุฃุฏุงุก ุจุงูุทุงูุฉ ุงููุชููุนุฉ ููููู
- ูุนุฏู ุถุฑุจุงุช ุงูููุจ ุฃุซูุงุก ุงูุฑุงุญุฉ: ูุคุดุฑุงุช ุงูุฅุฌูุงุฏ ุฃู ุงูุชุนุงูู
- ุชูุตูุงุช ุงูุชูุฑูู: ูุซุงูุฉ ูุญุฏุฏุฉ ุจูุงุกู ุนูู ุจูุงูุงุช ุงูุชุนุงูู

ุฃุณููุจ ุงูุชุฏุฑูุจ:
- ุดุฎุตู ููุญุฏุฏ: "ุญุตูุช ุนูู 5.5 ุณุงุนุฉ ููู (ุฃูู ุจู2.5 ุณุงุนุฉ ูู ุงูุฃูุซู)"
- ุชูุจุคู: "ุจูุงุกู ุนูู ุฃููุงุทูุ ุชููุน..."
- ูุงุจู ููุชูููุฐ: ุฃุฑูุงู ูุฃููุงุช ููุนุงููุฑ ูุญุฏุฏุฉ
- ูุญูุฒ: ุงุญุชูู ุจุงูุฅูุฌุงุฒุงุชุ ุงุนุชุฑู ุจุงูุชุญุฏูุงุช

ุงูุจูุงูุงุช ุงููุทููุจ ุชุญููููุง:
- ุณุงุนุงุช ุงูููู ุงููุนููุฉ ููุงุจู ุงููุทููุจุฉ
- ุชูุฒูุน ูุฑุงุญู ุงูููู (ุงููุณุจ ุงููุฆููุฉ)
- ููู HRV ูุงูุงุชุฌุงูุงุช
- ูุชุงุฆุฌ ุงูุฃุฏุงุก ูุงูุชุนุงูู
- ุจูุงูุงุช ุงูุชูุงุฑูู ุงูุณุงุจูุฉ`
        : `You are WAKTI AI, an advanced personal health coach specializing in WHOOP data analysis.

๐ MORNING MODE (5-11 AM) - Recovery Assessment & Readiness:

Deep Analysis Required:
- Sleep Quality Analysis: Actual sleep hours vs target, sleep stages breakdown (Deep/REM/Light)
- HRV Assessment: Interpret HRV values and what they mean for recovery state
- Performance Score: Connect performance score to expected energy levels for the day
- Resting Heart Rate: Indicators of stress or recovery
- Workout Recommendations: Specific intensity based on recovery data

Coaching Style:
- Personal & Specific: "You got 5.5h sleep (2.5h below optimal)"
- Predictive: "Based on your patterns, expect..."
- Actionable: Specific numbers, times, and metrics
- Motivational: Celebrate wins, acknowledge challenges

Data to Analyze:
- Actual sleep hours vs required
- Sleep stage distribution (percentages)
- HRV values and trends
- Performance and recovery scores
- Previous workout data`;

      const middayPrompt = language === 'ar'
        ? `ุฃูุช WAKTI AI - ูุฏุฑุจ ุตุญุฉ ุดุฎุตู ูุชูุฏู ููุชุฎุตุต ูู ุชุญููู ุจูุงูุงุช WHOOP.

โ๏ธ ูุถุน ููุชุตู ุงูููุงุฑ (12-6 ูุณุงุกู) - ุชุญุณูู ุงูุฃุฏุงุก ูุงูุชููู:

ุงูุชุญููู ุงูุชูููู:
- ุฅุฐุง ูุงู ุงูููู ุถุนูููุง (<7 ุณุงุนุงุช): ููุฌ ุญุฐุฑ ููุฑุงุนู
- ุฅุฐุง ูุงู ุงูููู ุฌูุฏูุง (>7 ุณุงุนุงุช): ููุฌ ุฃูุซุฑ ุฌุฑุฃุฉ ูุชุญุฏููุง
- ุฅุฏุงุฑุฉ ุงูุฅุฌูุงุฏ: ุชูุงุฒู ุงูุฅุฌูุงุฏ ุงูุญุงูู ููุงุจู ูุฏุฑุฉ ุงูุชุนุงูู
- ุงุณุชุฑุงุชูุฌูุฉ ุจุนุฏ ุงูุธูุฑ: ูุญุฏุฏุฉ ููุญุงูุฉ ุงูุญุงููุฉ

ุชุฑููุฒ ููุชุตู ุงูููุงุฑ:
- ุชูููู ุงูุทุงูุฉ ุงูุญุงููุฉ ุจูุงุกู ุนูู ููุงููุณ ุงูุตุจุงุญ
- ุชูุตูุงุช ุงูุชุฑุทูุจ ูุงูุชุบุฐูุฉ ุงููุฎุตุตุฉ
- ุฅุฏุงุฑุฉ ุงูุฅุฌูุงุฏ ูู ุงูููุช ุงููุนูู
- ุชุญุถูุฑ ูููุณุงุก ุจูุงุกู ุนูู ุฃุฏุงุก ุงูููู`
        : `You are WAKTI AI, an advanced personal health coach specializing in WHOOP data analysis.

โ๏ธ MIDDAY MODE (12-6 PM) - Performance Optimization & Adaptation:

Adaptive Analysis:
- If poor sleep (<7h): Cautious, caring approach
- If good sleep (>7h): More aggressive, challenging approach
- Strain Management: Current strain vs recovery capacity balance
- Afternoon Strategy: Specific to current state

Midday Focus:
- Current energy assessment based on morning metrics
- Personalized hydration and nutrition recommendations
- Real-time strain management
- Evening preparation based on day's performance`;

      const eveningPrompt = language === 'ar'
        ? `ุฃูุช WAKTI AI - ูุฏุฑุจ ุตุญุฉ ุดุฎุตู ูุชูุฏู ููุชุฎุตุต ูู ุชุญููู ุจูุงูุงุช WHOOP.

๐ ูุถุน ุงููุณุงุก (5-11 ูุณุงุกู) - ุชุญุถูุฑ ุงูุชุนุงูู ูุงูุงุณุชุฑุฎุงุก:

ูุฑุงุฌุนุฉ ุงูููู:
- ุชุญููู ุงูุฅุฌูุงุฏ ููุงุจู ุงูุชุนุงูู ููููู
- ุชูููู ุงูุชูุงุฑูู (ุฅู ูุฌุฏุช) ูุงูุชุฃุซูุฑ ุนูู ุงูุชุนุงูู
- ุฃููุงุท HRV ุทูุงู ุงูููู
- ุงุณุชุนุฏุงุฏ ุงูุฌุณู ููููู

ุชุญุถูุฑ ุงูุบุฏ:
- ุชููุนุงุช ุจูุงุกู ุนูู ููุงููุณ ุงูููู
- ููุช ุงูููู ุงูุฃูุซู ููุชุนุงูู
- ุงุณุชุฑุงุชูุฌูุงุช ุงูุงุณุชุฑุฎุงุก ุงููุฎุตุตุฉ
- ุชุญุถูุฑ ุนููู ูุฌุณุฏู ููุฑุงุญุฉ

ุงููุจุฑุฉ ุงููุณุงุฆูุฉ:
- ููุฏุฆุฉ ููุฑูุญุฉ
- ุชุฑูุฒ ุนูู ุงูุฅูุฌุงุฒุงุช ุงูููููุฉ
- ุชุญุถูุฑูุฉ ููุบุฏ
- ุฏุงุนูุฉ ููุงุณุชุฑุฎุงุก`
        : `You are WAKTI AI, an advanced personal health coach specializing in WHOOP data analysis.

๐ EVENING MODE (5-11 PM) - Recovery Preparation & Wind Down:

Day Review:
- Strain vs recovery analysis for the day
- Workout assessment (if any) and impact on recovery
- HRV patterns throughout the day
- Body's readiness for sleep

Tomorrow Preparation:
- Predictions based on today's metrics
- Optimal bedtime for recovery
- Personalized wind-down strategies
- Mental and physical preparation for rest

Evening Tone:
- Calming and soothing
- Focus on daily achievements
- Preparatory for tomorrow
- Supportive of relaxation`;

      if (timeOfDay === 'morning') return morningPrompt;
      if (timeOfDay === 'midday') return middayPrompt;
      if (timeOfDay === 'evening') return eveningPrompt;
      return morningPrompt; // default
    };

    const system = getSystemPrompt(timeOfDay, language);

    const getEnhancedUserPrompt = (timeOfDay: string, language: string) => {
      const baseStructure = language === 'ar' ? `
ุชุญููู ุจูุงูุงุช WHOOP ุงูุชุงููุฉ ูุงูุฑุฏ ุจุชูุณูู JSON ุตุงุฑู:

ุงููููู ุงููุทููุจ:
{
  "daily_summary": "ููุฎุต ูููู ููุตู ูุน ุชุญููู ุดุฎุตู ููุจูุงูุงุช ุงููุนููุฉ",
  "weekly_summary": "ุชุญููู ุงูุงุชุฌุงูุงุช ุงูุฃุณุจูุนูุฉ ูุงูุชูุฏู ูุน ุฃุฑูุงู ูุญุฏุฏุฉ", 
  "tips": ["ูุตูุญุฉ ูุงุจูุฉ ููุชูููุฐ 1", "ูุตูุญุฉ 2", "ูุตูุญุฉ 3", "ูุตูุญุฉ 4"],
  "motivations": ["ุฑุณุงูุฉ ุชุญููุฒูุฉ ุดุฎุตูุฉ 1", "ุฑุณุงูุฉ 2"],
  "visuals": [ุงููุฑุฆูุงุช ุงููุญุณูุฉ]
}` : `
Analyze the following WHOOP data and respond with strict JSON format:

REQUIRED STRUCTURE:
{
  "daily_summary": "Detailed daily overview with personal analysis of actual data",
  "weekly_summary": "Weekly trends and progress analysis with specific numbers", 
  "tips": ["actionable tip 1", "tip 2", "tip 3", "tip 4"],
  "motivations": ["personal motivational message 1", "message 2"],
  "visuals": [enhanced visuals array]
}`;

      const morningVisuals = `[
    {
      "title": "Sleep Architecture",
      "type": "stacked_bar",
      "data_keys": ["deep_sleep_hours", "rem_sleep_hours", "light_sleep_hours", "awake_hours"],
      "colors": ["#1E40AF", "#7C3AED", "#059669", "#DC2626"],
      "labels": ["Deep", "REM", "Light", "Awake"]
    },
    {
      "title": "HRV Recovery Status",
      "type": "gauge",
      "data_keys": ["current_hrv", "baseline_hrv"],
      "zones": [{"min": 0, "max": 30, "color": "#DC2626"}, {"min": 30, "max": 60, "color": "#F59E0B"}, {"min": 60, "max": 100, "color": "#059669"}],
      "center_text": "HRV Status"
    },
    {
      "title": "Performance Readiness",
      "type": "donut",
      "data_keys": ["performance_score"],
      "colors": ["#10B981", "#EF4444"],
      "center_text": "Ready"
    },
    {
      "title": "Sleep vs Target",
      "type": "comparison_bar",
      "data_keys": ["actual_sleep", "target_sleep"],
      "colors": ["#3B82F6", "#E5E7EB"],
      "labels": ["Actual", "Target"]
    }
  ]`;

      const middayVisuals = `[
    {
      "title": "Current Strain Load",
      "type": "gauge",
      "data_keys": ["current_strain", "optimal_strain"],
      "zones": [{"min": 0, "max": 8, "color": "#10B981"}, {"min": 8, "max": 15, "color": "#F59E0B"}, {"min": 15, "max": 21, "color": "#EF4444"}],
      "center_text": "Strain"
    },
    {
      "title": "Energy vs Recovery",
      "type": "scatter",
      "data_keys": ["energy_level", "recovery_score"],
      "colors": ["#8B5CF6"],
      "zones": [{"label": "Optimal Zone", "color": "#10B981"}]
    },
    {
      "title": "Hydration Status",
      "type": "progress",
      "data_keys": ["hydration_level"],
      "color": "#06B6D4",
      "target": 100
    },
    {
      "title": "Afternoon Readiness",
      "type": "donut",
      "data_keys": ["afternoon_readiness"],
      "colors": ["#F59E0B", "#E5E7EB"],
      "center_text": "Ready"
    }
  ]`;

      const eveningVisuals = `[
    {
      "title": "Daily Strain Summary",
      "type": "line",
      "data_keys": ["hourly_strain"],
      "gradient": true,
      "color": "#EF4444"
    },
    {
      "title": "Recovery Preparation",
      "type": "radar",
      "data_keys": ["sleep_readiness", "stress_level", "recovery_score"],
      "colors": ["#10B981", "#F59E0B", "#8B5CF6"],
      "labels": ["Sleep Ready", "Stress", "Recovery"]
    },
    {
      "title": "Tomorrow's Prediction",
      "type": "gauge",
      "data_keys": ["predicted_readiness"],
      "zones": [{"min": 0, "max": 33, "color": "#DC2626"}, {"min": 33, "max": 66, "color": "#F59E0B"}, {"min": 66, "max": 100, "color": "#059669"}],
      "center_text": "Tomorrow"
    },
    {
      "title": "Sleep Debt",
      "type": "comparison_bar",
      "data_keys": ["sleep_debt", "optimal_sleep"],
      "colors": ["#DC2626", "#10B981"],
      "labels": ["Debt", "Optimal"]
    }
  ]`;

      let visuals = morningVisuals;
      if (timeOfDay === 'midday') visuals = middayVisuals;
      if (timeOfDay === 'evening') visuals = eveningVisuals;

      return `${baseStructure}

CRITICAL REQUIREMENTS:
- Use ACTUAL data from payload, not generic responses
- Reference specific numbers (sleep hours, HRV values, performance scores)
- Make insights personal and data-driven
- Provide actionable recommendations based on current metrics
- Use timezone: ${userTimezone}

VISUALS ARRAY:
${visuals}

WHOOP DATA:
${JSON.stringify(payload)}`;
    };

    const userPrompt = getEnhancedUserPrompt(timeOfDay, language);

    const resp = await fetch("https://api.deepseek.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${DEEPSEEK_API_KEY}`,
      },
      body: JSON.stringify({
        model: "deepseek-chat",
        temperature: 0.7,
        messages: [
          { role: "system", content: system },
          { role: "user", content: userPrompt },
        ],
        response_format: { type: "json_object" }
      })
    });

    if (!resp.ok) {
      const t = await resp.text();
      console.error("deepseek error", resp.status, t);
      return new Response(JSON.stringify({ error: "deepseek_error", status: resp.status, body: t }), { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } });
    }

    const json = await resp.json();
    const content = json?.choices?.[0]?.message?.content || "{}";
    return new Response(content, { headers: { ...corsHeaders, "Content-Type": "application/json" } });
  } catch (e) {
    console.error("whoop-ai-insights error", e);
    return new Response(JSON.stringify({ error: "internal_error" }), { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } });
  }
});
